// Note: this file contains TypeScript errors, but these errors are incorrect. I'm not sure how to fix them.

import { getChainLogo, getChainName, isSupportedChain } from 'lib/utils/chains';
import { formatExploitAmount, getExploitBySlug, getUniqueChainIds } from 'lib/utils/exploits';
import { getTranslations } from 'next-intl/server';
import { ImageResponse } from 'next/og';

interface Props {
  params: {
    locale: string;
    slug: string;
  };
}

export const runtime = 'edge';
export const size = { width: 1200, height: 630 };
export const contentType = 'image/jpg';

// TODO: Static generation (similar to wallets/add-network)

const OgImage = async ({ params }: Props) => {
  const interSemiBold = await fetch(new URL('/public/assets/fonts/Inter-SemiBold.ttf', import.meta.url)).then((res) =>
    res.arrayBuffer(),
  );

  const inter = await fetch(new URL('/public/assets/fonts/Inter-Regular.ttf', import.meta.url)).then((res) =>
    res.arrayBuffer(),
  );

  const icon = await fetch(new URL('/public/assets/images/revoke-icon-orange-black.png', import.meta.url)).then((res) =>
    res.arrayBuffer(),
  );

  const t = await getTranslations({ locale: params.locale });
  const exploit = await getExploitBySlug(params.slug, params.locale);

  const numberOfChainsStr = t('exploits.meta.og.chains', { count: getUniqueChainIds(exploit).length });
  const stolenAmountStr = t('exploits.meta.og.amount', { amount: formatExploitAmount(exploit.amount) });

  const response = (
    <div tw="bg-white w-full h-full flex flex-col text-4xl leading-none items-center justify-center px-16">
      <div tw="text-7xl leading-none mb-10" style={{ fontFamily: 'Inter SemiBold' }}>
        {exploit.name}
      </div>
      <div style={{ display: 'flex', fontFamily: 'Inter' }}>
        <div>{exploit.date}</div>
        <div tw="border-r border-black h-full mx-8"></div>
        <div>{stolenAmountStr}</div>
        <div tw="border-r border-black h-full mx-8"></div>
        <div>{numberOfChainsStr}</div>
      </div>
      <div tw="flex mt-8 mb-12">
        {getUniqueChainIds(exploit).map((chainId, index) => (
          <ChainLogo chainId={chainId} key={index} />
        ))}
      </div>
      <div tw="flex items-center justify-center">
        <div tw="border-2 border-black bg-black text-white text-4xl py-4 px-10 h-[78px]">
          {t('exploits.meta.og.check')}
        </div>
        <img src={icon as any} height="78" />
      </div>
    </div>
  );

  return new ImageResponse(response, {
    ...size,
    fonts: [
      { name: 'Inter SemiBold', data: interSemiBold },
      { name: 'Inter', data: inter },
    ],
  });
};

const ChainLogo = ({ chainId, size }: { chainId: number; size?: number }) => {
  const name = getChainName(chainId);
  const src = getChainLogo(chainId);

  return (
    <img
      src={`https://revoke.cash/${src}`}
      alt={name}
      width={size ?? 48}
      height={size ?? 48}
      tw="bg-white shrink-0 rounded-full mx-1 border border-black"
      style={{
        filter: !isSupportedChain(chainId) ? 'grayscale(100%)' : '',
      }}
    />
  );
};

export default OgImage;
